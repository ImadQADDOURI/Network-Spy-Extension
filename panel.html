<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="panel.css" />
  </head>
  <body>
    <header class="topbar">
      <h2>üéØ Request Capture</h2>

      <div class="controls">
        <button id="recordBtn" class="btn-primary" title="Record / Pause">‚è∫ Record</button>
        <button id="clearBtn" title="Clear captured requests">üóë Clear</button>
        <button id="exportBtn" title="Export requests">‚¨á Export</button>
        <button id="rulesBtn" class="btn-accent" title="Manage rules">‚öô Rules</button>
        <button id="configBtn" title="Global configuration">‚öôÔ∏è Config</button>
      </div>
    </header>

    <div class="main-container">
      <!-- Rules Dashboard -->
      <section class="rules-panel">
        <div class="panel-header">
          <h3>Active Rules</h3>
          <span id="rulesCount" class="badge">0</span>
        </div>
        <div id="rulesList" class="rules-list"></div>
      </section>

      <!-- Requests Area -->
      <section class="requests-area">
        <!-- Filters & Search -->
        <div class="filter-bar">
          <input type="text" id="searchInput" placeholder="üîç Search requests..." />

          <select id="ruleFilter">
            <option value="">All Rules</option>
          </select>

          <select id="methodFilter">
            <option value="">All Methods</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>

          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="2xx">2xx</option>
            <option value="3xx">3xx</option>
            <option value="4xx">4xx</option>
            <option value="5xx">5xx</option>
          </select>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <label
            >Per page:
            <select id="pageSizeSelect">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </label>

          <button id="prevPage">‚óÄ</button>
          <span id="pageInfo">Page 1 / 1</span>
          <button id="nextPage">‚ñ∂</button>

          <span id="totalCount" class="muted">0 requests</span>
        </div>

        <!-- Requests List -->
        <div id="requestsList" class="requests-list"></div>

        <!-- Request Preview -->
        <div id="requestPreview" class="request-preview">
          <div class="preview-header">
            <h3>Request Details</h3>
            <div class="preview-actions">
              <select id="viewModeSelect" class="view-mode-select">
                <option value="collapsible">üìä Collapsible</option>
                <option value="formatted">üé® Formatted</option>
                <option value="raw">üìù Raw JSON</option>
              </select>
              <button id="curlBtn" title="Copy as cURL">üîÑ cURL</button>
              <button id="copyBtn" title="Copy full JSON">üìã Copy JSON</button>
            </div>
          </div>
          <div class="preview-meta" id="previewMeta"></div>
          <div id="previewContent" class="preview-content">Select a request to view details</div>
        </div>
      </section>
    </div>

    <!-- Rules Manager Modal -->
    <div id="rulesModal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>Rules Manager</h2>
          <button class="close-btn" id="closeRulesModal">√ó</button>
        </div>
        <div class="modal-body">
          <div class="rules-actions">
            <button id="addRuleBtn" class="btn-primary">+ Add Rule</button>
            <button id="importRulesBtn">üì• Import</button>
            <button id="exportRulesBtn">üì§ Export</button>
          </div>

          <div id="rulesManager" class="rules-manager"></div>
        </div>
      </div>
    </div>

    <!-- Rule Editor Modal -->
    <div id="ruleEditorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="editorTitle">Add Rule</h2>
          <button class="close-btn" id="closeEditorModal">√ó</button>
        </div>
        <div class="modal-body">
          <form id="ruleForm">
            <div class="form-group">
              <label>Rule Name *</label>
              <input type="text" id="ruleName" required placeholder="e.g., Facebook GraphQL" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Match Text</label>
                <input type="text" id="matchText" placeholder="Text to search for" />
              </div>

              <div class="form-group">
                <label>Match Field</label>
                <select id="matchField">
                  <option value="any">Any Field</option>
                  <option value="url">URL</option>
                  <option value="header">Headers</option>
                  <option value="body">Body</option>
                  <option value="queryParam">Query Params</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>HTTP Methods (leave empty for all)</label>
              <div class="checkbox-group">
                <label><input type="checkbox" value="GET" class="method-check" /> GET</label>
                <label><input type="checkbox" value="POST" class="method-check" /> POST</label>
                <label><input type="checkbox" value="PUT" class="method-check" /> PUT</label>
                <label><input type="checkbox" value="DELETE" class="method-check" /> DELETE</label>
                <label><input type="checkbox" value="PATCH" class="method-check" /> PATCH</label>
              </div>
            </div>

            <div class="form-group">
              <label>Domains (comma-separated, leave empty for all)</label>
              <input type="text" id="matchDomain" placeholder="e.g., facebook.com, graph.facebook.com" />
            </div>

            <div class="form-section">
              <h4>Capture Settings</h4>
              <div class="checkbox-group">
                <label><input type="checkbox" id="captureQueryParams" checked /> Query Parameters</label>
                <label><input type="checkbox" id="captureRequestHeaders" checked /> Request Headers</label>
                <label><input type="checkbox" id="captureRequestBody" checked /> Request Body</label>
                <label><input type="checkbox" id="captureResponseHeaders" checked /> Response Headers</label>
                <label><input type="checkbox" id="captureResponseBody" checked /> Response Body</label>
                <label><input type="checkbox" id="captureTiming" checked /> Timing Info</label>
              </div>
            </div>

            <div class="form-section">
              <h4>Header Filtering (Optional)</h4>

              <div class="form-group">
                <label>Filtering Mode</label>
                <select id="headerFilterMode">
                  <option value="none">No Filtering (Capture All Headers)</option>
                  <option value="exclude">Exclude Mode (Remove unwanted headers)</option>
                  <option value="include">Include Mode (Keep only specific headers)</option>
                </select>
              </div>

              <div id="excludeModeOptions" style="display: none">
                <div class="checkbox-group">
                  <label><input type="checkbox" id="excludePseudoHeaders" /> Exclude HTTP/2 pseudo-headers</label>
                  <label><input type="checkbox" id="excludeCommonHeaders" /> Exclude common browser headers</label>
                  <label
                    ><input type="checkbox" id="excludeSecurityHeaders" /> Exclude security headers (sec-*,
                    x-frame-options)</label
                  >
                  <label
                    ><input type="checkbox" id="excludeCacheHeaders" /> Exclude cache headers (cache-control, etag,
                    if-*)</label
                  >
                  <label><input type="checkbox" id="excludeCookies" /> Exclude cookies (cookie, set-cookie)</label>
                </div>
                <div class="form-group" style="margin-top: 12px">
                  <label>Additional headers to exclude (comma-separated)</label>
                  <input type="text" id="excludeHeadersCustom" placeholder="e.g., x-custom-header, internal-token" />
                </div>
              </div>

              <div id="includeModeOptions" style="display: none">
                <div class="form-group">
                  <label>Headers to include (comma-separated, ONLY these will be captured)</label>
                  <input
                    type="text"
                    id="includeHeadersCustom"
                    placeholder="e.g., x-fb-friendly-name, authorization, content-type"
                  />
                  <small style="color: var(--text-muted); display: block; margin-top: 4px">
                    üí° Tip: Use this for APIs with specific headers you care about
                  </small>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h4>Response Size Limits (Optional)</h4>
              <div class="form-group">
                <label>Max response body size (KB, 0 = unlimited)</label>
                <input type="number" id="maxResponseSize" value="0" min="0" placeholder="e.g., 500" />
                <small style="color: var(--text-muted); display: block; margin-top: 4px"
                  >Large responses will be truncated to save memory</small
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="keepLastOnly" />
                  Keep Last Match Only
                </label>
              </div>

              <div class="form-group">
                <label>Max Matches (0 = unlimited)</label>
                <input type="number" id="maxMatches" value="0" min="0" />
              </div>
            </div>

            <div class="form-group">
              <label>Notes</label>
              <textarea id="ruleNotes" rows="2" placeholder="Optional description"></textarea>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-primary">Save Rule</button>
              <button type="button" id="cancelRuleBtn">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <input type="file" id="importFileInput" accept=".json" style="display: none" />

    <!-- Config Modal -->
    <div id="configModal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>‚öôÔ∏è Global Configuration</h2>
          <button class="close-btn" id="closeConfigModal">√ó</button>
        </div>
        <div class="modal-body">
          <div class="config-section">
            <h3>Default Rule Values</h3>
            <p class="muted">These values will be used when creating new rules</p>

            <div class="form-group">
              <label>Default Max Response Size (KB, 0 = unlimited)</label>
              <input type="number" id="defaultMaxResponseSize" value="0" min="0" />
            </div>

            <div class="form-group">
              <label>Default Header Filter Mode</label>
              <select id="defaultHeaderFilterMode">
                <option value="none">No Filtering</option>
                <option value="exclude">Exclude Mode</option>
                <option value="include">Include Mode</option>
              </select>
            </div>
          </div>

          <div class="config-section">
            <h3>Header Presets</h3>
            <p class="muted">Customize which headers are considered "common", "security", etc.</p>

            <div class="form-group">
              <label>Common Browser Headers (comma-separated)</label>
              <textarea id="commonHeadersList" rows="3"></textarea>
              <button type="button" id="resetCommonHeaders" class="btn-small">Reset to Default</button>
            </div>

            <div class="form-group">
              <label>Security Headers (comma-separated)</label>
              <textarea id="securityHeadersList" rows="3"></textarea>
              <button type="button" id="resetSecurityHeaders" class="btn-small">Reset to Default</button>
            </div>

            <div class="form-group">
              <label>Cache Headers (comma-separated)</label>
              <textarea id="cacheHeadersList" rows="3"></textarea>
              <button type="button" id="resetCacheHeaders" class="btn-small">Reset to Default</button>
            </div>
          </div>

          <div class="config-section">
            <h3>Performance Settings</h3>

            <div class="form-group">
              <label>Max Stored Requests (Total)</label>
              <input type="number" id="maxStoredRequests" value="1000" min="100" step="100" />
              <small style="color: var(--text-muted); display: block; margin-top: 4px">
                Older requests will be automatically removed when limit is reached
              </small>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" id="saveConfig" class="btn-primary">üíæ Save Configuration</button>
            <button type="button" id="resetConfig" class="btn-danger">üîÑ Reset to Defaults</button>
          </div>
        </div>
      </div>
    </div>

    <script src="utils.js"></script>
    <script src="storage.js"></script>
    <script src="matcher.js"></script>
    <script src="panel.js"></script>
  </body>
</html>
